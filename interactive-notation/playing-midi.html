<!DOCTYPE html>
<html lang="en" xml:lang="en" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta charset="utf-8" />
        <title>Playing the MIDI output</title>
        <link rel="icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="apple-touch-icon" href="/assets/images/verovio-logo-big.png"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" /><!-- Latest compiled and minified CSS -->
        <link rel="stylesheet" href="/assets/css/bootstrap/css/bootstrap.min.css" type="text/css" /><!-- Optional theme -->
        <link rel="stylesheet" href="/assets/css/bootstrap/css/bootstrap-theme.min.css" type="text/css" />
        <link rel="stylesheet" href="/assets/css/fileinput.min.css" />

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/assets/css/syntax.css" />

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/assets/css/verovio.css" />
        <link rel="stylesheet" href="/assets/css/midiplayer.css" />

        <link rel="stylesheet" href="/css/verovio-site.css" />

        <script src="/assets/javascript/jquery-3.6.0.min.js" type="text/javascript" ></script>
        <script src="/assets/javascript/bootstrap.min.js" type="text/javascript" ></script>

        <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Playing the MIDI output | Reference book for Verovio</title>
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="Playing the MIDI output" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Verovio can produce basic MIDI files and this feature is also available in the JavaScript toolkit. It can be used to play an MEI file directly in the browser as demonstrated in this tutorial." />
<meta property="og:description" content="Verovio can produce basic MIDI files and this feature is also available in the JavaScript toolkit. It can be used to play an MEI file directly in the browser as demonstrated in this tutorial." />
<meta property="og:site_name" content="Reference book for Verovio" />
<meta property="og:image" content="https://book.verovio.org/images/card.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-12-20T13:34:38+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:image" content="https://book.verovio.org/images/card.png" />
<meta property="twitter:title" content="Playing the MIDI output" />
<meta name="twitter:site" content="@" />
<script type="application/ld+json">
{"description":"Verovio can produce basic MIDI files and this feature is also available in the JavaScript toolkit. It can be used to play an MEI file directly in the browser as demonstrated in this tutorial.","datePublished":"2022-12-20T13:34:38+00:00","dateModified":"2022-12-20T13:34:38+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"/interactive-notation/playing-midi.html"},"image":"https://book.verovio.org/images/card.png","url":"/interactive-notation/playing-midi.html","@type":"BlogPosting","headline":"Playing the MIDI output","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    </head>
    <body>

        <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
     <div class="container">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                </button>
            <a class="navbar-brand logo-nav" href="https://www.verovio.org/index.xhtml"><img src="/assets/images/verovio-fadded-50.png" /></a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
              <ul class="nav navbar-nav navbar-right">
                <li >
                    <a href="https://www.verovio.org/index.xhtml">Homepage</a>
                </li>
                <li class="active">
                    <a href="https://book.verovio.org/">Reference book</a>
                </li>
                <li >
                    <a href="https://www.verovio.org/musicxml.html">Online tools</a>
                </li>
              </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


        <div class="top-header"> 
    <div class="container" style="color: #eee; height: 140px; padding-top: 5px;">
        <h1 style="color: #eee;" class="hidden-print hidden-xs">A music notation engraving library</h1> 
        <h3 style="color: #eee;" class="hidden-print visible-xs">A music notation engraving library</h3> 
        <p class="hidden-print">Designed for the Music Encoding Initiative - Fast - Light - Flexible - No dependencies</p>
    </div>
</div>


        <div class="container with-footer">

            



<div class="row">
    <div class="col-md-3 sidebar-offcanvas" id="sidebar">
        <div class="toc-group">
            <div>

    <a class="toc-item" href="/introduction/">Introduction</a>
    

    <a class="toc-item" href="/first-steps/">Tutorial 1: First Steps</a>
    

    <a class="toc-item" href="/interactive-notation/css-and-svg.html">Tutorial 2: Interactive notation</a>
    
        
        
<a class="toc-item toc-section " href="/interactive-notation/css-and-svg.html">CSS and SVG</a>
    

<a class="toc-item toc-section " href="/interactive-notation/encoding-formats.html">Encoding formats</a>
    

<a class="toc-item toc-section selected" href="/interactive-notation/playing-midi.html">Playing the MIDI output</a>
    
        
        
<a class="toc-item toc-subsection" href="#add-a-midi-player">Add a MIDI player</a>

<a class="toc-item toc-subsection" href="#highlighting-the-notes-while-playing">Highlighting the notes while playing</a>

<a class="toc-item toc-subsection" href="#full-example">Full example</a>

    

<a class="toc-item toc-section " href="/interactive-notation/content-selection.html">Score content selection</a>
    

<a class="toc-item toc-section " href="/interactive-notation/editorial-markup.html">Interacting with editorial markup</a>
    

    

    <a class="toc-item" href="/advanced-topics/">Beyond tutorials: Advanced topics</a>
    

    <a class="toc-item" href="/toolkit-reference/input-formats.html">Toolkit Reference</a>
    

    <a class="toc-item" href="/installing-or-building-from-sources/command-line.html">Installing or building from sources</a>
    

    <a class="toc-item" href="/contributing/guidelines.html">Contributing</a>
    

</div>
            <div id="website-search-form" class="toc-item search-form">
    
    <form action="/search.html">
        <div class="form-group">
            <input id="website-search" class="form-control" type="text" name="q" placeholder="Search the reference book ...">
        </div>
        <button type="submit" class="btn btn-small">Search</button>
    </form>
</div>


        </div>
    </div>

    <div class="col-md-9" id="content">
        
        <a class="hidden-print" href="https://github.com/rism-digital/verovio-reference-book/edit/master/_book/03-interactive-notation/03-playing-midi.md"><button class="btn btn-xs pull-right">Edit this page</button></a>
        
        
        <h2>Playing the MIDI output</h2>
        <p>Verovio can produce basic MIDI files and this feature is also available in the JavaScript toolkit. It can be used to play an MEI file directly in the browser as demonstrated in this tutorial.</p>

<h3 id="add-a-midi-player">Add a MIDI player</h3>

<p>MIDI playback is not built-in to the web browser, nor available directly in Verovio. This means that we need to add a MIDI player to our page. For this tutorial we are going to use <a href="http://www.midijs.net/">MIDIjs</a>. You need to add a <code class="language-plaintext highlighter-rouge">&lt;script&gt;</code> tag with the following <code class="language-plaintext highlighter-rouge">src</code> attribute:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://www.midijs.net/lib/midi.js
</code></pre></div></div>

<p>We also need buttons to handle the start and stop playing events. Add them a the top of the body above the notation div:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nt">&lt;button</span> <span class="na">id=</span><span class="s">"playMIDI"</span><span class="nt">&gt;</span>Play<span class="nt">&lt;/button&gt;</span>
  <span class="nt">&lt;button</span> <span class="na">id=</span><span class="s">"stopMIDI"</span><span class="nt">&gt;</span>Stop<span class="nt">&lt;/button&gt;</span>
</code></pre></div></div>

<p>You also need to make sure they do something when clicking on them:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">playMIDI</span><span class="dl">"</span><span class="p">).</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">click</span><span class="dl">"</span><span class="p">,</span> <span class="nx">playMIDIHandler</span><span class="p">);</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">stopMIDI</span><span class="dl">"</span><span class="p">).</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">click</span><span class="dl">"</span><span class="p">,</span> <span class="nx">stopMIDIHandler</span><span class="p">);</span>
</code></pre></div></div>

<p>We now need to define what actually happens when the user clicks. That is, defining the <code class="language-plaintext highlighter-rouge">playMIDIHandler</code> and <code class="language-plaintext highlighter-rouge">stopMIDIHandler</code> functions we just bound to the button event listeners. We can scaffold them with:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">playMIDIHandler</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="c1">// do something to start playing</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">stopMIDIHandler</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="c1">// do something to stop playing</span>
<span class="p">}</span>
</code></pre></div></div>

<p>At this stage they do nothing. To start playing, we need to get the MIDI data produced by Verovio and pass it to the player. We will use the Verovio <code class="language-plaintext highlighter-rouge">renderToMIDI</code> method that returns a MIDI file encoded as a base64 string, which we can pass to MIDIjs:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Get the MIDI file from the Verovio toolkit</span>
<span class="kd">let</span> <span class="nx">base64midi</span> <span class="o">=</span> <span class="nx">tk</span><span class="p">.</span><span class="nx">renderToMIDI</span><span class="p">();</span>
<span class="c1">// Add the data URL prefixes describing the content</span>
<span class="kd">let</span> <span class="nx">midiString</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">data:audio/midi;base64,</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">base64midi</span><span class="p">;</span>
<span class="c1">// Pass it to play to MIDIjs</span>
<span class="nx">MIDIjs</span><span class="p">.</span><span class="nx">play</span><span class="p">(</span><span class="nx">midiString</span><span class="p">);</span>
</code></pre></div></div>

<p>Stop playing is even simpler. You only need to tell MIDIjs to do so:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">MIDIjs</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
</code></pre></div></div>

<p>The examples above will be followed to write the body of the <code class="language-plaintext highlighter-rouge">playMIDIHandler</code> and <code class="language-plaintext highlighter-rouge">stopMIDIHandler</code> functions.</p>

<h3 id="highlighting-the-notes-while-playing">Highlighting the notes while playing</h3>

<p>The MIDIjs player provides us with a callback function that gives us the current playback time. We can use this for highlighting the notes as the MIDI file plays! Each time the callback function is called, we can highlight the notes that are currently played, and automatically move to the next page if necessary.</p>

<p>You need to start by defining a callback function, similar to the button event we wrote earlier:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">midiHightlightingHandler</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Do something everytime the callback function is called</span>
<span class="p">}</span>
</code></pre></div></div>

<p>You will notice that the function has an <code class="language-plaintext highlighter-rouge">event</code> parameter that will give us information about the current event. What we need to use is <code class="language-plaintext highlighter-rouge">event.time</code> that indicates the current playing time in seconds. We are going to use this and the Verovio <code class="language-plaintext highlighter-rouge">getElementsAtTime</code> method that retrieves all elements being played at a given time in order to obtain the list of notes being played:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Get elements at a time in milliseconds (time from the player is in seconds)</span>
<span class="kd">let</span> <span class="nx">currentElements</span> <span class="o">=</span> <span class="nx">tk</span><span class="p">.</span><span class="nx">getElementsAtTime</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">time</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>
</code></pre></div></div>

<p>Now we should check that a page number was set. This is just to ensure we do not end up in an undefined state; for example, if the file is not loaded, or if we asked for elements that do not exist. If the page is 0, something went wrong and we should return:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="nx">currentElements</span><span class="p">.</span><span class="nx">page</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</code></pre></div></div>

<p>We should also check that we are currently rendering the correct page. If not, we should load it first:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="nx">currentElements</span><span class="p">.</span><span class="nx">page</span> <span class="o">!=</span> <span class="nx">currentPage</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">currentPage</span> <span class="o">=</span> <span class="nx">currentElements</span><span class="p">.</span><span class="nx">page</span><span class="p">;</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">notation</span><span class="dl">"</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">tk</span><span class="p">.</span><span class="nx">renderToSVG</span><span class="p">(</span><span class="nx">currentPage</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>To do the highlighting of the notes we are going to use a CSS rule to be defined in the <code class="language-plaintext highlighter-rouge">style.css</code> file. A simple way to do it is to add a class <code class="language-plaintext highlighter-rouge">playing</code> to be applied to <code class="language-plaintext highlighter-rouge">g.notes</code> and that changes the color:</p>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">g</span><span class="nc">.note.playing</span> <span class="p">{</span>
  <span class="py">fill</span><span class="p">:</span> <span class="no">crimson</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now we can actually highlight the notes. To do so, we are going to loop over the list of notes listed in <code class="language-plaintext highlighter-rouge">currentElements</code> and simply add the <code class="language-plaintext highlighter-rouge">playing</code> class to them:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Get all notes playing and set the class</span>
<span class="k">for</span> <span class="p">(</span><span class="nx">note</span> <span class="k">of</span> <span class="nx">currentElements</span><span class="p">.</span><span class="nx">notes</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">noteElement</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="nx">note</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">noteElement</span><span class="p">)</span> <span class="nx">noteElement</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="dl">"</span><span class="s2">playing</span><span class="dl">"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Finally, we need to bind the MIDIjs player with the callback function we have defined. This will be done with:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">MIDIjs</span><span class="p">.</span><span class="nx">player_callback</span> <span class="o">=</span> <span class="nx">midiHightlightingHandler</span><span class="p">;</span>
</code></pre></div></div>

<p>This should not work! However, if it does, you will notice that we also need to de-highlight the notes that are not played anymore, otherwise they will stay highlighted. This should be done at the beginning of the <code class="language-plaintext highlighter-rouge">midiHightlightingHandler</code> callback function by removing the <code class="language-plaintext highlighter-rouge">playing</code> class to the notes that currently have it:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Remove the attribute 'playing' of all notes previously playing</span>
<span class="kd">let</span> <span class="nx">playingNotes</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="dl">'</span><span class="s1">g.note.playing</span><span class="dl">'</span><span class="p">);</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">playingNote</span> <span class="k">of</span> <span class="nx">playingNotes</span><span class="p">)</span> <span class="nx">playingNote</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="dl">"</span><span class="s2">playing</span><span class="dl">"</span><span class="p">);</span>
</code></pre></div></div>

<p>The code above needs to be placed within the body of the <code class="language-plaintext highlighter-rouge">midiHighlightingHandler</code> function.</p>

<h3 id="full-example">Full example</h3>

<p>Open <a href="/tutorials/midi.html" target="_blank">this example</a> in a new window.</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"viewport"</span> <span class="na">content=</span><span class="s">"width=device-width"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;title&gt;</span>MIDI playback<span class="nt">&lt;/title&gt;</span>
        <span class="c">&lt;!-- A stylesheet for modifying the appearance of the notes being played --&gt;</span>
        <span class="nt">&lt;link</span> <span class="na">href=</span><span class="s">"midi.css"</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">type=</span><span class="s">"text/css"</span> <span class="nt">/&gt;</span>
        <span class="c">&lt;!-- Verovio --&gt;</span>
        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"https://www.verovio.org/javascript/develop/verovio-toolkit-wasm.js"</span> <span class="na">defer</span><span class="nt">&gt;&lt;/script&gt;</span>
        <span class="c">&lt;!-- A JavaScript MIDI player --&gt;</span>
        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">'https://www.midijs.net/lib/midi.js'</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;/head&gt;</span>
    <span class="nt">&lt;body&gt;</span>
        <span class="nt">&lt;button</span> <span class="na">id=</span><span class="s">"playMIDI"</span><span class="nt">&gt;</span>Play<span class="nt">&lt;/button&gt;</span>
        <span class="nt">&lt;button</span> <span class="na">id=</span><span class="s">"stopMIDI"</span><span class="nt">&gt;</span>Stop<span class="nt">&lt;/button&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"notation"</span><span class="nt">&gt;&lt;/div&gt;</span>
        <span class="nt">&lt;script&gt;</span>
            <span class="cm">/** 
                We need to wait for the whole page to load before we try to 
                work with Verovio.
            **/</span>
            <span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">DOMContentLoaded</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="nx">verovio</span><span class="p">.</span><span class="nx">module</span><span class="p">.</span><span class="nx">onRuntimeInitialized</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                    <span class="c1">// This line initializes the Verovio toolkit</span>
                    <span class="kd">const</span> <span class="nx">tk</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">verovio</span><span class="p">.</span><span class="nx">toolkit</span><span class="p">();</span>

                    <span class="nx">tk</span><span class="p">.</span><span class="nx">setOptions</span><span class="p">({</span>
                        <span class="na">pageWidth</span><span class="p">:</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">clientWidth</span><span class="p">,</span>
                        <span class="na">pageHeight</span><span class="p">:</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">clientHeight</span><span class="p">,</span>
                        <span class="na">scaleToPageSize</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
                    <span class="p">});</span>

                    <span class="c1">// The current page, which will change when playing through the piece</span>
                    <span class="kd">let</span> <span class="nx">currentPage</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

                    <span class="cm">/**
                     The handler to start playing the file
                    **/</span>
                    <span class="kd">const</span> <span class="nx">playMIDIHandler</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                        <span class="c1">// Get the MIDI file from the Verovio toolkit</span>
                        <span class="kd">let</span> <span class="nx">base64midi</span> <span class="o">=</span> <span class="nx">tk</span><span class="p">.</span><span class="nx">renderToMIDI</span><span class="p">();</span>
                        <span class="c1">// Add the data URL prefixes describing the content</span>
                        <span class="kd">let</span> <span class="nx">midiString</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">data:audio/midi;base64,</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">base64midi</span><span class="p">;</span>
                        <span class="c1">// Pass it to play to MIDIjs</span>
                        <span class="nx">MIDIjs</span><span class="p">.</span><span class="nx">play</span><span class="p">(</span><span class="nx">midiString</span><span class="p">);</span>
                    <span class="p">}</span>

                    <span class="cm">/**
                     The handler to stop playing the file
                    **/</span>
                    <span class="kd">const</span> <span class="nx">stopMIDIHandler</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
                        <span class="nx">MIDIjs</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
                    <span class="p">}</span>

                    <span class="kd">const</span> <span class="nx">midiHightlightingHandler</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
                        <span class="c1">// Remove the attribute 'playing' of all notes previously playing</span>
                        <span class="kd">let</span> <span class="nx">playingNotes</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="dl">'</span><span class="s1">g.note.playing</span><span class="dl">'</span><span class="p">);</span>
                        <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">playingNote</span> <span class="k">of</span> <span class="nx">playingNotes</span><span class="p">)</span> <span class="nx">playingNote</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="dl">"</span><span class="s2">playing</span><span class="dl">"</span><span class="p">);</span>

                        <span class="c1">// Get elements at a time in milliseconds (time from the player is in seconds)</span>
                        <span class="kd">let</span> <span class="nx">currentElements</span> <span class="o">=</span> <span class="nx">tk</span><span class="p">.</span><span class="nx">getElementsAtTime</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">time</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>

                        <span class="k">if</span> <span class="p">(</span><span class="nx">currentElements</span><span class="p">.</span><span class="nx">page</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

                        <span class="k">if</span> <span class="p">(</span><span class="nx">currentElements</span><span class="p">.</span><span class="nx">page</span> <span class="o">!=</span> <span class="nx">currentPage</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">currentPage</span> <span class="o">=</span> <span class="nx">currentElements</span><span class="p">.</span><span class="nx">page</span><span class="p">;</span>
                            <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">notation</span><span class="dl">"</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">tk</span><span class="p">.</span><span class="nx">renderToSVG</span><span class="p">(</span><span class="nx">currentPage</span><span class="p">);</span>
                        <span class="p">}</span>

                        <span class="c1">// Get all notes playing and set the class</span>
                        <span class="k">for</span> <span class="p">(</span><span class="nx">note</span> <span class="k">of</span> <span class="nx">currentElements</span><span class="p">.</span><span class="nx">notes</span><span class="p">)</span> <span class="p">{</span>
                            <span class="kd">let</span> <span class="nx">noteElement</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="nx">note</span><span class="p">);</span>
                            <span class="k">if</span> <span class="p">(</span><span class="nx">noteElement</span><span class="p">)</span> <span class="nx">noteElement</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="dl">"</span><span class="s2">playing</span><span class="dl">"</span><span class="p">);</span>
                        <span class="p">}</span>
                    <span class="p">}</span>

                    <span class="cm">/**
                        Wire up the buttons to actually work.
                    */</span>
                    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">playMIDI</span><span class="dl">"</span><span class="p">).</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">click</span><span class="dl">"</span><span class="p">,</span> <span class="nx">playMIDIHandler</span><span class="p">);</span>
                    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">stopMIDI</span><span class="dl">"</span><span class="p">).</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">click</span><span class="dl">"</span><span class="p">,</span> <span class="nx">stopMIDIHandler</span><span class="p">);</span>
                    <span class="cm">/**
                     Set the function as message callback
                    */</span>
                    <span class="nx">MIDIjs</span><span class="p">.</span><span class="nx">player_callback</span> <span class="o">=</span> <span class="nx">midiHightlightingHandler</span><span class="p">;</span>

                    <span class="c1">// This line fetches the MEI file we want to render...</span>
                    <span class="nx">fetch</span><span class="p">(</span><span class="dl">"</span><span class="s2">https://www.verovio.org/examples/downloads/Schubert_Lindenbaum.mei</span><span class="dl">"</span><span class="p">)</span>
                    <span class="c1">// ... then receives the response and "unpacks" the MEI from it</span>
                    <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">text</span><span class="p">())</span>
                    <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">meiXML</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
                        <span class="c1">// ... then we can load the data into Verovio ...</span>
                        <span class="nx">tk</span><span class="p">.</span><span class="nx">loadData</span><span class="p">(</span><span class="nx">meiXML</span><span class="p">);</span>
                        <span class="c1">// ... and generate the SVG for the first page ...</span>
                        <span class="kd">let</span> <span class="nx">svg</span> <span class="o">=</span> <span class="nx">tk</span><span class="p">.</span><span class="nx">renderToSVG</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
                        <span class="c1">// ... and finally gets the </span><span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span> <span class="nx">element</span> <span class="kd">with</span> <span class="nx">the</span> <span class="nx">ID</span> <span class="nx">we</span> <span class="nx">specified</span><span class="p">,</span> 
                        <span class="c1">// and sets the content (innerHTML) to the SVG that we just generated.</span>
                        <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">notation</span><span class="dl">"</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">svg</span><span class="p">;</span>
                    <span class="p">});</span>
                <span class="p">}</span>
            <span class="p">});</span>
        <span class="nt">&lt;/script&gt;</span>
    <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

    </div>
</div>

<script src="/js/highlighter.js"></script>

<script>
    let options = {
        rootMargin: '60px'
    }
    function adjustSideBar() {
        elem = document.getElementsByClassName("toc-group")[0];
        // 992 is the breakpoint for which the sidebar moves to the top; 35 is the footer height
        elem.style.height = (window.innerWidth < 992) ? "" : `${window.innerHeight - elem.offsetTop - 35}px`;
    }

    window.onresize = function () {
        adjustSideBar();
    };
    window.onload = function() {
        adjustSideBar();
    };

    window.addEventListener('DOMContentLoaded', () => {
        const observer = new IntersectionObserver(entries => {
            entries.forEach(entry => {
                const id = entry.target.getAttribute('id');
                if (entry.intersectionRatio > 0) {
                    // First deselect everything
                    sections = document.querySelectorAll(`.toc-group a.toc-subsection`);
                    for (i = 0; i < sections.length; i++){
                        sections[i].classList.remove('selected');
                    }
                    // The one entering is marked as .on-screen
                    document.querySelector(`.toc-group a[href="#${id}"]`).classList.add('on-screen');
                    // Select the first that in .on-screen
                    sections = document.querySelectorAll(`.toc-group a.toc-subsection.on-screen`);
                    sections[0].classList.add('selected');

                } else {
                    leaving = document.querySelector(`.toc-group a[href="#${id}"]`)
                    // Remove the .on-screen from the one leaving
                    leaving.classList.remove('on-screen');
                    sections = document.querySelectorAll(`.toc-group a.toc-subsection.on-screen`);
                    // If no other one is on screen, just leave things as they are
                    if (sections.length > 0) {
                        // Otherwise de-select the one that is leaving
                        leaving.classList.remove('selected');
                        // Selected the first .on-screen one and de-select the other ones
                        sections[0].classList.add('selected');
                        for (i = 1; i < sections.length; i++){
                            console.log(sections[i].getAttribute('id'))
                            sections[i].classList.remove('selected');
                        }
                    }
                }
            });
        }, options);

        // Track all sections that have an `id` applied
        document.querySelectorAll('h3[id]').forEach((section) => {
            observer.observe(section);
        });

    });

    let params = new URLSearchParams( document.location.search.substring( 1 ) );
    if ( params.get( "q" ) )
    {
        let query = params.get( "q" );
        // Also make sure we preserve the query term in the form in the sidebar
        document.getElementById("website-search").value = query;
        // Preserve the original query for logging
        let query_term = query;
        // Remove quotes and trim
        query = query.replace(/\'|\"/g, ' ');
        query = query.trim();
        // Make it an AND query
        console.log(query);

        let terms = query.split(' ');
        var container = document.getElementById("content");

        for (var i = 0; i < terms.length; i++) {
            InstantSearch.highlight(container, terms[i]);
        }
    }

</script>



        </div>

        <footer class="hidden-print footer navbar-fixed-bottom">
            <p>
                
            </p>
        </footer>

        <script type="text/javascript">
        //<![CDATA[
            $(document).ready(function() {

                

            });
        //]]>
        </script>
    </body>
</html>
